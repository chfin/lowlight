<!DOCTYPE html>
<html lang=en>
 <head>
  <meta charset=UTF-8>
  <title>lowlight.lisp</title>
  <link rel=stylesheet href=example.css>
 </head>
 <body>
  <pre>
<code><span class="comment">;;;; lowlight.lisp

</span>(<span class="stdmacro">in-package</span> #:<span class="symbol">lowlight</span>)

(<span class="define">defparameter</span> <span class="vardefname">*styles*</span> <span class="symbol">nil</span>)

(<span class="define">defun</span> <span class="defname">wrap</span> (<span class="stdfun">fn</span> <span class="symbol">n</span> <span class="symbol">lst</span> <span class="lambda">&amp;optional</span> <span class="symbol">coll</span>)
  (<span class="specialop">if</span> <span class="symbol">lst</span>
      (<span class="specialop">if</span> (<span class="stdfun">=</span> (<span class="stdfun">length</span> <span class="symbol">coll</span>) (<span class="stdfun">-</span> <span class="symbol">n</span> <span class="number">1</span>))
	  (<span class="stdfun">append</span> (<span class="stdfun">funcall</span> <span class="symbol">fn</span> (<span class="stdfun">reverse</span> (<span class="stdfun">cons</span> (<span class="stdfun">car</span> <span class="symbol">lst</span>) <span class="symbol">coll</span>)))
		  (<span class="stdfun">wrap</span> <span class="symbol">fn</span> <span class="symbol">n</span> (<span class="stdfun">cdr</span> <span class="symbol">lst</span>)))
	  (<span class="stdfun">wrap</span> <span class="symbol">fn</span> <span class="symbol">n</span> (<span class="stdfun">cdr</span> <span class="symbol">lst</span>) (<span class="stdfun">cons</span> (<span class="stdfun">car</span> <span class="symbol">lst</span>) <span class="symbol">coll</span>)))
      (<span class="stdfun">reverse</span> <span class="symbol">coll</span>)))

(<span class="define">defun</span> <span class="defname">process-substring</span> (<span class="stdfun">regex</span> <span class="symbol">n</span> <span class="symbol">wrapper</span> <span class="symbol">string</span>)
  (<span class="stdfun">wrap</span> <span class="symbol">wrapper</span> <span class="symbol">n</span> (<span class="stdfun">cl-ppcre:split</span> <span class="symbol">regex</span> <span class="symbol">string</span>
				  <span class="keyword">:with-registers-p</span> <span class="symbol">t</span>
				  <span class="keyword">:omit-unmatched-p</span> <span class="symbol">t</span>)))

(<span class="define">defun</span> <span class="defname">cat-strings</span> (<span class="stdfun">lst</span> <span class="lambda">&amp;optional</span> <span class="symbol">strs</span>)
  (<span class="specialop">if</span> (<span class="stdfun">stringp</span> (<span class="stdfun">car</span> <span class="symbol">lst</span>))
      (<span class="stdfun">cat-strings</span> (<span class="stdfun">cdr</span> <span class="symbol">lst</span>) (<span class="stdfun">cons</span> (<span class="stdfun">car</span> <span class="symbol">lst</span>) <span class="symbol">strs</span>))
      (<span class="specialop">let</span> ((<span class="stdfun">next</span> (<span class="stdmacro">when</span> <span class="symbol">lst</span> (<span class="stdfun">cons</span> (<span class="stdfun">car</span> <span class="symbol">lst</span>) (<span class="stdfun">cat-strings</span> (<span class="stdfun">cdr</span> <span class="symbol">lst</span>))))))
	(<span class="specialop">if</span> <span class="symbol">strs</span>
	    (<span class="stdfun">cons</span> (<span class="stdfun">apply</span> <span class="quote">#'</span><span class="symbol">concatenate</span> (<span class="stdfun">cons</span> <span class="quote">'</span><span class="symbol">string</span> (<span class="stdfun">reverse</span> <span class="symbol">strs</span>))) <span class="symbol">next</span>)
	    <span class="symbol">next</span>))))

(<span class="define">defun</span> <span class="defname">process-rule</span> (<span class="stdfun">regex</span> <span class="symbol">n</span> <span class="symbol">wrapper</span> <span class="symbol">lst</span>)
  (<span class="stdfun">cat-strings</span> (<span class="stdfun">apply</span> <span class="quote">#'</span><span class="symbol">append</span>
		      (<span class="stdfun">mapcar</span> (<span class="stdmacro">lambda</span> (<span class="stdfun">i</span>)
				(<span class="specialop">if</span> (<span class="stdfun">stringp</span> <span class="symbol">i</span>)
				    (<span class="stdfun">process-substring</span>
				     (<span class="stdfun">cl-ppcre:create-scanner</span>
				      <span class="symbol">regex</span> <span class="keyword">:single-line-mode</span> <span class="symbol">t</span>
				      <span class="keyword">:case-insensitive-mode</span> <span class="symbol">t</span>)
				     <span class="symbol">n</span> <span class="symbol">wrapper</span> <span class="symbol">i</span>)
				    (<span class="stdfun">list</span> <span class="symbol">i</span>)))
			      <span class="symbol">lst</span>))))

(<span class="define">defun</span> <span class="defname">htmlifier</span> (<span class="stdfun">stream</span>)
  (<span class="stdmacro">lambda</span> (<span class="stdfun">item</span>)
    (<span class="specialop">if</span> (<span class="stdfun">consp</span> <span class="symbol">item</span>)
	(<span class="stdfun">format</span> <span class="symbol">stream</span> <span class="string">"&lt;span class=\"~a\"&gt;~a&lt;/span&gt;"</span> (<span class="stdfun">car</span> <span class="symbol">item</span>)
		(<span class="stdfun">cl-who:escape-string-minimal</span> (<span class="stdfun">cdr</span> <span class="symbol">item</span>)))
	(<span class="stdfun">format</span> <span class="symbol">stream</span> <span class="string">"~a"</span> <span class="symbol">item</span>))))

(<span class="define">defun</span> <span class="defname">to-html</span> (<span class="stdfun">lst</span>)
  (<span class="withmacro">with-output-to-string</span> (<span class="stdfun">stream</span>)
    (<span class="stdfun">mapcar</span> (<span class="stdfun">htmlifier</span> <span class="symbol">stream</span>) <span class="symbol">lst</span>)))

(<span class="define">defun</span> <span class="defname">md-regex</span> (<span class="stdfun">blocks</span>)
  (<span class="stdfun">cl-ppcre:create-scanner</span>
   (<span class="stdfun">format</span> <span class="symbol">nil</span> <span class="string">"```(~{~a~^|~}).(.*?)```"</span> (<span class="specialop">if</span> (<span class="stdfun">listp</span> <span class="symbol">blocks</span>) <span class="symbol">blocks</span> (<span class="stdfun">list</span> <span class="symbol">blocks</span>)))
   <span class="keyword">:single-line-mode</span> <span class="symbol">t</span> <span class="keyword">:case-insensitive-mode</span> <span class="symbol">t</span>))

(<span class="define">defun</span> <span class="defname">md-wrapper</span> (<span class="stdfun">style</span>)
  (<span class="stdmacro">lambda</span> (<span class="stdfun">parts</span>)
    (<span class="stdfun">list</span> (<span class="stdfun">car</span> <span class="symbol">parts</span>)
	  (<span class="specialop">let</span> ((<span class="global">*print-pretty*</span> <span class="symbol">nil</span>))
	    (<span class="stdfun">spinneret:</span><span class="withmacro">with-html-string</span>
	      (<span class="keyword">:pre</span> (<span class="keyword">:code</span> (<span class="keyword">:raw</span> (<span class="stdfun">light</span> <span class="symbol">style</span> (<span class="stdfun">caddr</span> <span class="symbol">parts</span>))))))))))

(<span class="define">defun</span> <span class="defname">light-blocks</span> (<span class="stdfun">style</span> <span class="symbol">input</span> <span class="lambda">&amp;optional</span> (<span class="stdfun">blocks</span> <span class="symbol">style</span>))
  (<span class="specialop">let</span> ((<span class="stdfun">parts</span> (<span class="stdfun">cl-ppcre:split</span> (<span class="stdfun">md-regex</span> <span class="symbol">blocks</span>) <span class="symbol">input</span> <span class="keyword">:with-registers-p</span> <span class="symbol">t</span>)))
    (<span class="stdfun">apply</span> <span class="quote">#'</span><span class="symbol">concatenate</span> (<span class="stdfun">cons</span> <span class="quote">'</span><span class="symbol">string</span> (<span class="stdfun">wrap</span> (<span class="stdfun">md-wrapper</span> <span class="symbol">style</span>) <span class="number">3</span> <span class="symbol">parts</span>)))))

(<span class="define">defun</span> <span class="defname">light</span> (<span class="stdfun">style</span> <span class="symbol">input</span>)
  (<span class="specialop">let</span> ((<span class="stdfun">style-rules</span> (<span class="stdfun">cdr</span> (<span class="stdfun">assoc</span> <span class="symbol">style</span> <span class="global">*styles*</span>)))
	(<span class="stdmacro">step</span> (<span class="stdfun">list</span> <span class="symbol">input</span>)))
    (<span class="stdmacro">loop</span> <span class="symbol">for</span> <span class="symbol">rule</span> <span class="symbol">in</span> <span class="symbol">style-rules</span>
       <span class="symbol">do</span> (<span class="stdmacro">setf</span> <span class="symbol">step</span> (<span class="stdfun">process-rule</span> (<span class="stdfun">car</span> <span class="symbol">rule</span>) (<span class="stdfun">cadr</span> <span class="symbol">rule</span>)
				   (<span class="stdfun">caddr</span> <span class="symbol">rule</span>) <span class="symbol">step</span>)))
    (<span class="stdfun">to-html</span> (<span class="stdfun">remove</span> <span class="symbol">nil</span> <span class="symbol">step</span>))))

(<span class="define">defun</span> <span class="defname">light-file</span> (<span class="stdfun">style</span> <span class="symbol">in</span> <span class="lambda">&amp;key</span> <span class="symbol">out</span> <span class="symbol">css</span> <span class="symbol">title</span> <span class="symbol">raw</span>)
  (<span class="stdmacro">unless</span> <span class="symbol">out</span> (<span class="stdmacro">setf</span> <span class="symbol">out</span> (<span class="stdfun">make-pathname</span> <span class="keyword">:type</span> <span class="string">"html"</span> <span class="keyword">:defaults</span> <span class="symbol">in</span>)))
  (<span class="specialop">let*</span> ((<span class="stdfun">str</span> (<span class="stdfun">alexandria:read-file-into-string</span> <span class="symbol">in</span>))
	 (<span class="stdfun">result</span> (<span class="stdfun">light</span> <span class="symbol">style</span> <span class="symbol">str</span>)))
    (<span class="withmacro">with-open-file</span>
	(<span class="stdfun">spinneret:</span><span class="global">*html*</span> <span class="symbol">out</span> <span class="keyword">:direction</span> <span class="keyword">:output</span> <span class="keyword">:if-exists</span> <span class="keyword">:supersede</span>)
      (<span class="specialop">if</span> <span class="symbol">raw</span>
	  (<span class="stdfun">princ</span> <span class="symbol">result</span> <span class="symbol">spinneret:</span><span class="global">*html*</span>)
	  (<span class="stdfun">spinneret:</span><span class="withmacro">with-html</span>
	    (<span class="keyword">:doctype</span>)
	    (<span class="keyword">:html</span> (<span class="keyword">:head</span> (<span class="keyword">:title</span> (<span class="stdmacro">or</span> <span class="symbol">title</span> (<span class="stdfun">file-namestring</span> <span class="symbol">in</span>)))
			  (<span class="stdmacro">when</span> <span class="symbol">css</span> (<span class="keyword">:link</span> <span class="keyword">:rel</span> <span class="string">"stylesheet"</span> <span class="keyword">:href</span> <span class="symbol">css</span>)))
		   (<span class="keyword">:body</span>
		    (<span class="keyword">:pre</span> (<span class="keyword">:code</span> (<span class="specialop">let</span> ((<span class="global">*print-pretty*</span> <span class="symbol">nil</span>))
				   (<span class="keyword">:raw</span> <span class="symbol">result</span>)))))))))))

(<span class="define">defun</span> <span class="defname">light-file-blocks</span> (<span class="stdfun">style</span> <span class="symbol">in</span> <span class="lambda">&amp;key</span> <span class="symbol">out</span> (<span class="stdfun">blocks</span> <span class="symbol">style</span>))
  (<span class="stdmacro">unless</span> <span class="symbol">out</span> (<span class="stdmacro">setf</span> <span class="symbol">out</span> (<span class="stdfun">make-pathname</span> <span class="keyword">:type</span> <span class="string">"html"</span> <span class="keyword">:defaults</span> <span class="symbol">in</span>)))
  (<span class="specialop">let</span> ((<span class="stdfun">str</span> (<span class="stdfun">alexandria:read-file-into-string</span> <span class="symbol">in</span>)))
    (<span class="withmacro">with-open-file</span> (<span class="stdfun">stream</span> <span class="symbol">out</span> <span class="keyword">:direction</span> <span class="keyword">:output</span> <span class="keyword">:if-exists</span> <span class="keyword">:supersede</span>)
      (<span class="stdfun">princ</span> (<span class="stdfun">light-blocks</span> <span class="symbol">style</span> <span class="symbol">str</span> <span class="symbol">blocks</span>) <span class="symbol">stream</span>)))
  <span class="symbol">t</span>)

(<span class="define">defmacro</span> <span class="defname">define-style</span> (<span class="stdfun">style</span> <span class="lambda">&amp;body</span> <span class="symbol">clauses</span>)
  (<span class="specialop">let*</span> ((<span class="stdfun">p-reg</span> (<span class="stdfun">gensym</span>))
	 (<span class="stdfun">rules</span> (<span class="stdfun">mapcar</span> (<span class="stdmacro">lambda</span> (<span class="stdfun">clause</span>)
			  (<span class="specialop">let</span> ((<span class="stdfun">r</span> (<span class="stdfun">car</span> <span class="symbol">clause</span>)))
			    <span class="quote">`</span>(<span class="stdfun">list</span> <span class="quote">,</span>(<span class="specialop">if</span> (<span class="stdfun">stringp</span> <span class="symbol">r</span>) <span class="symbol">r</span> <span class="quote">`</span>(<span class="stdfun">format</span> <span class="symbol">nil</span> <span class="quote">,</span><span class="symbol">@r</span>))
				   (<span class="number">1</span><span class="symbol">+</span> <span class="quote">,</span>(<span class="stdfun">cadr</span> <span class="symbol">clause</span>))
				   (<span class="stdmacro">lambda</span> (<span class="quote">,</span><span class="symbol">p-reg</span>)
				     <span class="quote">,</span>(<span class="stdfun">cons</span> <span class="quote">'</span><span class="symbol">list</span>
					    (<span class="stdfun">cons</span> <span class="quote">`</span>(<span class="stdfun">car</span> <span class="quote">,</span><span class="symbol">p-reg</span>) (<span class="stdfun">cddr</span> <span class="symbol">clause</span>)))))))
			 <span class="symbol">clauses</span>)))
    <span class="quote">`</span>(<span class="specialop">macrolet</span> ((<span class="stdfun">$</span> (<span class="stdfun">n</span>) (<span class="stdfun">list</span> <span class="quote">'</span><span class="symbol">nth</span> <span class="symbol">n</span> <span class="quote">',</span><span class="symbol">p-reg</span>)))
       (<span class="stdmacro">setf</span> <span class="global">*styles*</span> (<span class="stdfun">cons</span> (<span class="stdfun">cons</span> <span class="quote">,</span><span class="symbol">style</span> <span class="quote">,</span>(<span class="stdfun">cons</span> <span class="quote">'</span><span class="symbol">list</span> <span class="symbol">rules</span>))
			      (<span class="stdfun">remove</span> <span class="quote">,</span><span class="symbol">style</span> <span class="global">*styles*</span> <span class="keyword">:key</span> <span class="quote">#'</span><span class="symbol">car</span>))))))
   </code>
  </pre>
 </body>
</html>
